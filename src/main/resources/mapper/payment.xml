<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.guideyou.repository.interfaces.payment.PaymentRepository">

	<insert id="insertPayment">
		
		INSERT INTO payment(merchant_uid, user_id, total_price, payment_status)
		VALUES (#{merchantUid}, #{userId}, #{totalPrice}, #{paymentStatus})
	
	</insert>
	
	<select id="findByUserId" resultType="com.guideyou.repository.entity.Payment">
		SELECT user_id FROM payment WHERE user_id = #{userId}
	</select>

	<select id="getPurchasedProductInfoList" resultType="com.guideyou.dto.payment.PurchasedProductInfoDTO">
		SELECT
		b.product_id,
		d.city_name, 							-- 사용자가 구매한 상품의 지역명
		c.title AS product_title,				-- 사용자가 구매한 상품의 제목
		a.payment_date,							-- 사용자가 결제한 날짜
		e.upload_file_name AS product_image		-- 사용자가 구매한 상품의 썸네일 사진
		FROM
		payment a
		JOIN
		payment_detail b ON a.merchant_uid = b.merchant_uid
		JOIN
		product c ON b.product_id = c.id
		LEFT JOIN
		city_code d ON c.city_code_id = d.id
		LEFT JOIN
		product_photos e ON c.id = e.product_id AND e.thumbnail IS NOT NULL
		WHERE
		a.user_id = #{userId}
		and a.payment_status = 'paid';
	</select>

</mapper>