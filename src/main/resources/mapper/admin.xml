<?xml version="1.0" encoding="UTF-8"?>
<!-- 24.02.29 관리자 페이지 xml -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.guideyou.repository.interfaces.admin.AdminRepository">
	
	<!-- 최근 생성된 상품 정보 조회 -->
	<select id="findLatestPosts" resultType="com.guideyou.dto.product.ProductDto">
		SELECT u.nickname as nickName, p.id as productId, p.user_id as userId, p.title, p.price, p.created_at as createdAt
        FROM product p
        JOIN user u ON p.user_id = u.id
        ORDER BY p.created_at DESC
	</select>
	
	<!-- 오늘 최근 상품 정보 -->
	<select id="findLatestPostsD" resultType="com.guideyou.dto.product.ProductDto">
		SELECT u.nickname as nickName, p.id as productId, p.user_id as userId, p.title, p.price, p.created_at as createdAt
        FROM product p
        JOIN user u ON p.user_id = u.id
        where p.created_at <![CDATA[>=]]> date_format(now(),'%Y-%m-%d 00:00:00') and p.created_at <![CDATA[<=]]> date_format(now(),'%Y-%m-%d 23:59:59')
        ORDER BY p.created_at DESC
	</select>
	
	
	<!-- 이번 달 최근 상품 정보 -->
	<select id="findLatestPostsM" resultType="com.guideyou.dto.product.ProductDto">
		SELECT u.nickname as nickName, p.id as productId, p.user_id as userId, p.title, p.price, p.created_at as createdAt
        FROM product p
        JOIN user u ON p.user_id = u.id
        where p.created_at <![CDATA[>=]]> date_format(now(),'%Y-%m-01 00:00:00') and p.created_at <![CDATA[<]]> date_format(DATE_ADD(now(),INTERVAL 1 MONTH),'%Y-%m-01 00:00:00')
        ORDER BY p.created_at DESC
	</select>
	
	
	<!-- 올 해 최근 상품 정보 -->
	<select id="findLatestPostsY" resultType="com.guideyou.dto.product.ProductDto">
		SELECT u.nickname as nickName, p.id as productId, p.user_id as userId, p.title, p.price, p.created_at as createdAt
        FROM product p
        JOIN user u ON p.user_id = u.id
        where p.created_at <![CDATA[>=]]> date_format(now(),'%Y-01-01 00:00:00') and p.created_at <![CDATA[<]]> date_format(DATE_ADD(now(),INTERVAL 1 year),'%Y-01-01 00:00:00')
        ORDER BY p.created_at DESC
	</select>
	
	
	
	<!-- 인기 상품 조회 -->
	<select id="findProductInfo" resultType="com.guideyou.dto.product.ProductDto">
		SELECT p.id AS productId,
	       p.intro_content,
	       p.content,
	       p.price,
	       p.sold_count,
	       p.created_at,
	       ph.upload_file_name AS uploadFileName,
	       (p.price * p.sold_count) AS revenue
		FROM product p
		JOIN product_photos ph ON p.id = ph.product_id AND ph.thumbnail IS NOT NULL
		ORDER BY p.id
	</select>
	
	
	<!-- 오늘 인기 상품 정보 -->
	<select id="findProductInfoD" resultType="com.guideyou.dto.product.ProductDto">
		SELECT p.id AS productId,
	       p.intro_content,
	       p.content,
	       p.price,
	       p.sold_count,
	       p.created_at,
	       ph.upload_file_name AS uploadFileName,
	       (p.price * p.sold_count) AS revenue
		FROM product p
		JOIN product_photos ph ON p.id = ph.product_id AND ph.thumbnail IS NOT NULL
		where p.created_at <![CDATA[>=]]> date_format(now(),'%Y-%m-%d 00:00:00') and p.created_at <![CDATA[<=]]> date_format(now(),'%Y-%m-%d 23:59:59')
		ORDER BY p.id
	</select>
	
	
	<!-- 이번달 인기 상품 정보 -->
	<select id="findProductInfoM" resultType="com.guideyou.dto.product.ProductDto">
		SELECT p.id AS productId,
	       p.intro_content,
	       p.content,
	       p.price,
	       p.sold_count,
	       p.created_at,
	       ph.upload_file_name AS uploadFileName,
	       (p.price * p.sold_count) AS revenue
		FROM product p
		JOIN product_photos ph ON p.id = ph.product_id AND ph.thumbnail IS NOT NULL
		where p.created_at <![CDATA[>=]]> date_format(now(),'%Y-%m-01 00:00:00') and p.created_at <![CDATA[<]]> date_format(DATE_ADD(now(),INTERVAL 1 MONTH),'%Y-%m-01 00:00:00')
		ORDER BY p.id
	</select>
	
	
	<!-- 올해 인기 상품 정보 -->
	<select id="findProductInfoY" resultType="com.guideyou.dto.product.ProductDto">
		SELECT p.id AS productId,
	       p.intro_content,
	       p.content,
	       p.price,
	       p.sold_count,
	       p.created_at,
	       ph.upload_file_name AS uploadFileName,
	       (p.price * p.sold_count) AS revenue
		FROM product p
		JOIN product_photos ph ON p.id = ph.product_id AND ph.thumbnail IS NOT NULL
		where p.created_at <![CDATA[>=]]> date_format(now(),'%Y-01-01 00:00:00') and p.created_at <![CDATA[<]]> date_format(DATE_ADD(now(),INTERVAL 1 year),'%Y-01-01 00:00:00')
		ORDER BY p.id
	</select>
	

	
	<!-- 판매 된 상품 개수 조회 -->
	<select id="selectPaymentInfo" resultType="com.guideyou.dto.admin.AdminDto">
		select count(*) as paymentCount from payment
	</select>
	
	<!-- 오늘 판매 된 상품 개수 조회 -->
	<select id="selectPaymentInfoD" resultType="com.guideyou.dto.admin.AdminDto">
		select count(*) as paymentCount from payment
		where payment_date <![CDATA[>=]]> date_format(now(),'%Y-%m-%d 00:00:00') and payment_date <![CDATA[<=]]> date_format(now(),'%Y-%m-%d 23:59:59')
	</select>
	
	<!-- 이번 달 판매 된 상품 개수 조회 -->
	<select id="selectPaymentInfoM" resultType="com.guideyou.dto.admin.AdminDto">
		select count(*) as paymentCount from payment
		where payment_date <![CDATA[>=]]> date_format(now(),'%Y-%m-01 00:00:00') and payment_date <![CDATA[<]]> date_format(DATE_ADD(now(),INTERVAL 1 MONTH),'%Y-%m-01 00:00:00')
	</select>
	
	<!-- 올해 판매 된 상품 개수 조회 -->
	<select id="selectPaymentInfoY" resultType="com.guideyou.dto.admin.AdminDto">
		select count(*) as paymentCount from payment
		where payment_date <![CDATA[>=]]> date_format(now(),'%Y-01-01 00:00:00') and payment_date <![CDATA[<]]> date_format(DATE_ADD(now(),INTERVAL 1 year),'%Y-01-01 00:00:00')
	</select>
	
	
	
	<!-- 총 판매 금액 조회 -->
	<select id="selectTotalPriceInfo" resultType="com.guideyou.dto.admin.AdminDto">
		select sum(total_price) as totalPrice from payment
	</select>
	
	<!-- 오늘 총 판매 금액 조회 -->
	<select id="selectTotalPriceInfoD" resultType="com.guideyou.dto.admin.AdminDto">
		select sum(total_price) as totalPrice from payment
		where payment_date <![CDATA[>=]]> date_format(now(),'%Y-%m-%d 00:00:00') and payment_date <![CDATA[<=]]> date_format(now(),'%Y-%m-%d 23:59:59')
	</select>
	
	<!-- 이번 달 총 판매 금액 조회 -->
	<select id="selectTotalPriceInfoM" resultType="com.guideyou.dto.admin.AdminDto">
		select sum(total_price) as totalPrice from payment
		where payment_date <![CDATA[>=]]> date_format(now(),'%Y-%m-01 00:00:00') and payment_date <![CDATA[<]]> date_format(DATE_ADD(now(),INTERVAL 1 MONTH),'%Y-%m-01 00:00:00')
	</select>
	
	<!-- 올해 총 판매 금액 조회 -->
	<select id="selectTotalPriceInfoY" resultType="com.guideyou.dto.admin.AdminDto">
		select sum(total_price) as totalPrice from payment
		where payment_date <![CDATA[>=]]> date_format(now(),'%Y-01-01 00:00:00') and payment_date <![CDATA[<]]> date_format(DATE_ADD(now(),INTERVAL 1 year),'%Y-01-01 00:00:00')
	</select>
	
	
	
	<!-- 가입자 수 조회 -->
	<select id="selectTotalUserInfo" resultType="com.guideyou.dto.admin.AdminDto">
		select count(*) as userCount from user
	</select>
	
	<!-- 오늘 가입자 수 조회 -->
	<select id="selectTotalUserInfoD" resultType="com.guideyou.dto.admin.AdminDto">
		select count(*) as userCount from user
		where created_at <![CDATA[>=]]> date_format(now(),'%Y-%m-%d 00:00:00') and created_at <![CDATA[<=]]> date_format(now(),'%Y-%m-%d 23:59:59')
	</select>
	
	<!-- 이번 달 가입자 수 조회 -->
	<select id="selectTotalUserInfoM" resultType="com.guideyou.dto.admin.AdminDto">
		select count(*) as userCount from user
		where created_at <![CDATA[>=]]> date_format(now(),'%Y-%m-01 00:00:00') and created_at <![CDATA[<]]> date_format(DATE_ADD(now(),INTERVAL 1 MONTH),'%Y-%m-01 00:00:00')
	</select>	
	
	<!-- 올해 가입자 수 조회 -->
	<select id="selectTotalUserInfoY" resultType="com.guideyou.dto.admin.AdminDto">
		select count(*) as userCount from user
		where created_at <![CDATA[>=]]> date_format(now(),'%Y-01-01 00:00:00') and created_at <![CDATA[<]]> date_format(DATE_ADD(now(),INTERVAL 1 year),'%Y-01-01 00:00:00')
	</select>
	
	
	
	
	<!-- 게시글 조회 -->
	<select id="selectBoardList" resultType="com.guideyou.dto.admin.BoardDto">
		select id as boardId, `type`, title, content from board_contents
	</select>
	
	<!-- 오늘 게시글 조회 -->
	<select id="selectBoardListD" resultType="com.guideyou.dto.admin.BoardDto">
		select id as boardId, `type`, title, substring(content, 1, 10) as content from board_contents
		where created_at <![CDATA[>=]]> date_format(now(),'%Y-%m-%d 00:00:00') and created_at <![CDATA[<=]]> date_format(now(),'%Y-%m-%d 23:59:59')
	</select>
	
	<!-- 이번 달 게시글 조회 -->
	<select id="selectBoardListM" resultType="com.guideyou.dto.admin.BoardDto">
		select id as boardId, `type`, title, substring(content, 1, 10) as content from board_contents
		where created_at <![CDATA[>=]]> date_format(now(),'%Y-%m-01 00:00:00') and created_at <![CDATA[<]]> date_format(DATE_ADD(now(),INTERVAL 1 MONTH),'%Y-%m-01 00:00:00')
	</select>
	
	<!-- 올해 게시글 조회 -->
	<select id="selectBoardListY" resultType="com.guideyou.dto.admin.BoardDto">
		select id as boardId, `type`, title, substring(content, 1, 10) as content from board_contents
		where created_at <![CDATA[>=]]> date_format(now(),'%Y-01-01 00:00:00') and created_at <![CDATA[<]]> date_format(DATE_ADD(now(),INTERVAL 1 year),'%Y-01-01 00:00:00')
	</select>
	
	
	<!-- 오늘 상품 판매 개수, 수익, 가입자 수 조회 -->
	<select id="chartInformationListD" resultType="hashmap" parameterType="String">
		WITH T1 AS (
		SELECT DATE_FORMAT(payment_date, '%Y-%m-%d %H:00:00') as dt1, COUNT(*) AS pay_cnt, SUM(total_price) AS total FROM payment u
		WHERE payment_date <![CDATA[>=]]> DATE_FORMAT(NOW(),'%Y-%m-%d 00:00:00')
		GROUP BY DATE_FORMAT(payment_date, '%Y-%m-%d %H:00:00')
		), T2 AS (
		SELECT DATE_FORMAT(created_at, '%Y-%m-%d %H:00:00') as dt2, COUNT(*) as user_cnt FROM user u
		WHERE created_at <![CDATA[>=]]> DATE_FORMAT(NOW(),'%Y-%m-%d 00:00:00')
		GROUP BY DATE_FORMAT(created_at, '%Y-%m-%d %H:00:00')
		)
		
		SELECT if(dt1 IS NULL,dt2,dt1) AS createdAt
		, if(pay_cnt IS NULL,0,pay_cnt) AS paymentCount
		, if(total IS NULL,0,total) AS totalPrice
		, if(user_cnt IS NULL,0,user_cnt) AS userCount
		FROM
		(
		SELECT * FROM T1
		LEFT JOIN T2
		ON T1.dt1 = T2.dt2
		UNION
		SELECT * FROM T1
		RIGHT JOIN T2
		ON T1.dt1 = T2.dt2
		) AS test
	</select>
	
	<!-- 이번 달 상품 판매 개수, 수익, 가입자 수 조회 -->
	<select id="chartInformationListM" resultType="hashmap" parameterType="String">
		WITH T1 AS (
		SELECT DATE_FORMAT(payment_date, '%Y-%m-%d') as dt1, COUNT(*) AS pay_cnt, SUM(total_price) AS total FROM payment u
		WHERE payment_date <![CDATA[>=]]> DATE_FORMAT(NOW(),'%Y-%m-01 00:00:00')
		GROUP BY DATE_FORMAT(payment_date, '%Y-%m-%d')
		), T2 AS (
		SELECT DATE_FORMAT(created_at, '%Y-%m-%d') as dt2, COUNT(*) as user_cnt FROM user u
		WHERE created_at <![CDATA[>=]]> DATE_FORMAT(NOW(),'%Y-%m-01 00:00:00')
		GROUP BY DATE_FORMAT(created_at, '%Y-%m-%d')
		)
		
		SELECT if(dt1 IS NULL,dt2,dt1) AS createdAt
		, if(pay_cnt IS NULL,0,pay_cnt) AS paymentCount
		, if(total IS NULL,0,total) AS totalPrice
		, if(user_cnt IS NULL,0,user_cnt) AS userCount
		FROM
		(
		SELECT * FROM T1
		LEFT JOIN T2
		ON T1.dt1 = T2.dt2
		UNION
		SELECT * FROM T1
		RIGHT JOIN T2
		ON T1.dt1 = T2.dt2
		) AS test
	</select>
	
	<!-- 올해 상품 판매 개수, 수익, 가입자 수 조회 -->
	<select id="chartInformationListY" resultType="hashmap" parameterType="String">
		WITH T1 AS (
		SELECT DATE_FORMAT(payment_date, '%Y-%m') as dt1, COUNT(*) AS pay_cnt, SUM(total_price) AS total FROM payment u
		WHERE payment_date <![CDATA[>=]]> DATE_FORMAT(NOW(),'%Y-01-01 00:00:00')
		GROUP BY DATE_FORMAT(payment_date, '%Y-%m')
		), T2 AS (
		SELECT DATE_FORMAT(created_at, '%Y-%m') as dt2, COUNT(*) as user_cnt FROM user u
		WHERE created_at <![CDATA[>=]]> DATE_FORMAT(NOW(),'%Y-01-01 00:00:00')
		GROUP BY DATE_FORMAT(created_at, '%Y-%m')
		)
		
		SELECT if(dt1 IS NULL,dt2,dt1) AS createdAt
		, if(pay_cnt IS NULL,0,pay_cnt) AS paymentCount
		, if(total IS NULL,0,total) AS totalPrice
		, if(user_cnt IS NULL,0,user_cnt) AS userCount
		FROM
		(
		SELECT * FROM T1
		LEFT JOIN T2
		ON T1.dt1 = T2.dt2
		UNION
		SELECT * FROM T1
		RIGHT JOIN T2
		ON T1.dt1 = T2.dt2
		) AS test
	</select>
	
	
	<!-- 관리자 페이지 수익 리스트 조회 -->
	<select id="selectPaymentInfoList" resultType="com.guideyou.dto.admin.AdminPaymentListDto">
		select * from payment
		limit #{limit} offset #{offset}  
	</select>
	
	<!-- 관리자 페이지 가입 된 회원 정보 조회 -->
	<select id="selectUserInfoList" resultType="com.guideyou.dto.admin.AdminUserInfoDto">
		select * from user
		limit #{limit} offset #{offset}  
	</select>
	
	<!-- 수익 데이터 개수 조회 -->
	<select id="getPaymentCount" resultType="int">
	 	select count(*) from board_contents
	</select>
	
	<!-- 회원 정보 개수 조회 -->
	<select id="getUserCount" resultType="int">
	 	select count(*) from user
	</select>
	
	
	
</mapper>