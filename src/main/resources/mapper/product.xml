<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.guideyou.repository.interfaces.ProductRepository">

	<insert id="insert" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
		insert into product(city_code_id, title, price, content)
		values (#{cityCodeId}, #{title}, #{price}, #{content})
	</insert>
	
	<update id="updateById">
		update product set city_code_id = #{cityCodeId}, title = #{title},
		price = #{price}, content = #{content} where id = #{id}
	</update>
	
	<update id="updateBySoldCount">
		update product set sold_count = #{soldCount} where id = #{id}
	</update>
	
	<update id="updateByWishCount">
		update product set wish_count = #{wishCount} where id = #{id}
	</update>
	
	<update id="updateByViewCount">
		update product set view_count = #{viewCount} where id = #{id}
	</update>

	<delete id="deletById">
		delete from product where id = #{id}
	</delete>
	
	<select id="findAllByUserId" resultType="com.guideyou.repository.entity.Product">
		select * from product where user_id = #{userId}
	</select>
	
	<select id="findByProductId" resultType="com.guideyou.repository.entity.Product">
		select * from product where id = #{id}
	</select>
		
	<select id="findAll" resultType="com.guideyou.repository.entity.Product">
		select * from product
	</select>
	
	<select id="selectByTitle" resultType="com.guideyou.repository.entity.Product">
		select * from product where title like CONCAT('%', #{title}, '%')
	</select>	
	
	
	<select id="findProductsWithImages" resultType="com.guideyou.repository.entity.Product">
		SELECT p.*, pi.upload_file_name AS uploadFileName
	    FROM product p
	    LEFT JOIN product_photos pi ON p.id = pi.product_id
	    GROUP BY p.id
	    ORDER BY p.created_at DESC
	</select>
	
	
	<!-- citycode로 인한 출력 -->
	<select id="findProductsByCityCode" resultType="com.guideyou.repository.entity.Product">
		SELECT p FROM Product p WHERE p.city_code_id = #{cityCodeId}
	</select>
	
	<!-- 페이지 처리 -->
	<select id="findAllwithPasing" resultType="com.guideyou.dto.ProductSaveFormDto">
		select * from product p
		left join product_photos ph on p.id = ph.product_id
		group by p.id
        limit #{limit} offset #{offset}	
	</select>
	
	<select id="getTotalCount" resultType="int">
		select count(*) from product
	</select>
	
	
	<!-- 비동기적 페이징 처리 -->
	<select id="getProductsWithPaging" resultType="com.guideyou.dto.ProductSaveFormDto">
	    SELECT * FROM product
	    LIMIT #{size} OFFSET #{offset}
	</select>
	
	<select id="getTotalProductCount" resultType="int">
	    SELECT COUNT(*) FROM product
	</select>
	
	
	<!-- 인기 상품 목록 조회 - 판매 순 -->
	<select id="popularProduct" resultType="com.guideyou.dto.ProductSaveFormDto">
		SELECT p.*, pi.upload_file_name AS uploadFileName
	    FROM product p
	    LEFT JOIN product_photos pi ON p.id = pi.product_id
	    GROUP BY p.id
	    ORDER BY p.sold_count DESC;
	</select>
	
	<!-- title 검색 -->
	<select id="searchTitle" resultType="com.guideyou.dto.ProductSaveFormDto">
		SELECT *
	    FROM product p
	    LEFT JOIN product_photos ph ON p.id = ph.product_id
	    WHERE p.title LIKE CONCAT('%', #{title}, '%')
	    GROUP BY p.id
	    LIMIT #{limit} OFFSET #{offset} 
	
	</select>
	
		
	
</mapper>