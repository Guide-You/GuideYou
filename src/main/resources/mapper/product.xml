<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.guideyou.repository.interfaces.product.ProductRepository">

	<insert id="insert" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
		insert into product(user_id, city_code_id, title, price, intro_content, content)
		values (#{userId}, #{cityCodeId}, #{title}, #{price}, #{introContent}, #{content})
	</insert>
	
	<update id="updateById">
		update product set city_code_id = #{cityCodeId}, title = #{title},
		price = #{price}, content = #{content} where id = #{id}
	</update>
	
	<update id="updateBySoldCount">
		update product set sold_count = sold_count + 1  where id = #{id}
	</update>
	
	<update id="updateByWishCount">
		update product set wish_count = wish_count + 1 #{wishCount} where id = #{id}
	</update>
	
	<update id="updateByViewCount">
		update product set view_count = view_count + 1 #{viewCount} where id = #{id}
	</update>

	<delete id="deletById">
		delete from product where id = #{id}
	</delete>
	
	<select id="selectProductInf" resultType="com.guideyou.dto.product.ProductDto">
		SELECT p.city_code_id, p.title, p.intro_content, p.content, p.price,
		ph.product_id, ph.upload_file_name, ph.thumbnail
		FROM product AS p
		LEFT JOIN product_photos AS ph ON p.id = ph.product_id
	</select>
	
	<select id="findAllByUserId" resultType="com.guideyou.repository.entity.Product">
		select * from product where user_id = #{userId}
	</select>
							
	
	<!-- 페이지 처리와 검색 -->
	<select id="findAllwithPasing" resultType="com.guideyou.dto.product.ProductDto">
		SELECT DISTINCT p.id, p.title, substring(p.intro_content, 1, 15) As content, p.price, ph.upload_file_name, ph.thumbnail, c.*
		FROM product p
		LEFT JOIN product_photos ph ON p.id = ph.product_id AND ph.thumbnail IS NOT NULL
		LEFT JOIN city_code c ON p.city_code_id = c.id
		WHERE 1 = 1
		<if test="searchText != null and searchText != ''">
		    AND (title LIKE CONCAT('%', #{searchText}, '%') OR content LIKE CONCAT('%', #{searchText}, '%'))
		</if>
		<if test="cityCodeId != null and cityCodeId != ''">
		    AND city_code_id = #{cityCodeId}
		</if>
		ORDER BY p.id DESC
		LIMIT #{limit} OFFSET #{offset}
	</select>
	
	<select id="getTotalCount" resultType="int">
		select count(*) from product as p
		LEFT JOIN product_photos ph ON p.id = ph.product_id AND ph.thumbnail IS NOT NULL
		LEFT JOIN city_code c ON p.city_code_id = c.id
		where 1 = 1
	    <if test="searchText != null and searchText != ''">
		    and title like CONCAT('%', #{searchText}, '%') or content like CONCAT('%', #{searchText} , '%')
	    </if>
	    <if test="cityCodeId != null and cityCodeId != ''">
	    	and city_code_id = #{cityCodeId} 	
	    </if>
	</select>
		
	<!-- 인기 상품 목록 조회 - 판매 순 -->
	<select id="popularProduct" resultType="com.guideyou.dto.product.ProductDto">
		SELECT p.*, pi.upload_file_name AS uploadFileName
	    FROM product p
	    LEFT JOIN product_photos pi ON p.id = pi.product_id
	    GROUP BY p.id
	    ORDER BY p.sold_count DESC
	</select>
		
	<!-- 상품 상세보기 페이지에서 필요한 모든 정보 찾기 -->
	<select id="findAllProductDetail" resultType="com.guideyou.dto.product.ProductDetailDto">
		select p.id AS productId, p.user_id, p.title, p.content AS productContent, p.price, p.sold_count,
		ph.upload_file_name AS uploadFileName, ph.thumbnail,
		u.nickname, u.email,
		r.score, r.content AS reviewContent, r.created_at AS reviewCreatedAt
		from product p
		left join product_photos ph ON p.id = ph.product_id
		left join user u on u.id = p.user_id
		left join review r on r.r_product_id = p.id
		where p.id = #{productId}
		order by p.id
	</select>
	
	<!-- detail 상품 정보 -->
	<select id="findProductAndUser" resultType="com.guideyou.dto.product.ProductDetailDto">
		select a.id as productId, a.title as productTitle, a.intro_content as introProductContent, a.content as productContent, a.price, a.sold_count, 
		b.nickname, b.email, a.user_id
		from product a 
		join user b on a.user_id = b.id
		where a.id = #{productId}
	</select>
	
	<!-- 상품 사진 리스트 -->
	<select id="findByProductImg" resultType="com.guideyou.dto.product.ProductPhotoDto">
		select p.*, ph.upload_file_name as uploadFileName
		from product p 
        left join product_photos ph on p.id = ph.product_id 
		where product_id = #{productId}	
	</select>		
	
	<!-- 2024.02.27 리뷰 조회 -->
	<select id="findReviewByProduct" resultType="com.guideyou.dto.product.ProductReviewDto">
		select a.content, a.created_at, b.name, a.score, d.upload_file_name  
		from review a 
		join user b on a.w_user_id = b. id
		join product c on a.r_product_id = c.id
		left join user_profile_photos d on b.id = d.user_id
		where a.r_product_id = #{rProductId}
	</select>
	
	<!-- 24.02.28 상품 평점 조회 -->
	<select id="productAvg" resultType="com.guideyou.dto.product.ProductReviewDto">
		SELECT round(avg(score), 1) as avgScore
		FROM review
		WHERE r_product_id = #{rProductId}
	</select>
	
	<!-- 24.02.28 아이디에 해당하는 상품 정보 조회 -->
	<select id="selectProductInfo" resultType="com.guideyou.repository.entity.Product">
		select * from product where id = #{id}
	</select>
	
	
	<!-- 마이페이지 사용자가 작성한 상품 목록 조회 -->
		<!-- *************** 최장호 추가 02/26 ************************** -->
	<select id="getUploadProductsInfoByUserId" parameterType="map" resultType="com.guideyou.dto.product.UploadProductsInfoDTO">
		SELECT 
		a.id AS product_id,
		b.city_name, 
		c.upload_file_name, 
		a.title,
		substring(a.content, 1, 10) AS short_content, 
		a.price AS product_price, 
		a.created_at AS upload_time 
		FROM product a 
		LEFT JOIN
		city_code b ON a.city_code_id = b.id 
		LEFT JOIN 
		product_photos c ON a.id = c.product_id and c.thumbnail is not null
		WHERE a.user_id = #{userId}
		ORDER BY a.created_at DESC
		limit  #{size} offset  #{offset}
	</select>
	
	<select id="getUploadProductsInfoTotalCount" resultType="long">
		SELECT 
		count(*)
		FROM product a 
		LEFT JOIN
		city_code b ON a.city_code_id = b.id 
		LEFT JOIN 
		product_photos c ON a.id = c.product_id and c.thumbnail is not null
		WHERE a.user_id = #{id};
	</select>	
	<!-- ************************************************************************************** -->
		
		
		
	<!-- 24.03.03 결제 취소시 soldCount -1 -->
	<update id="updateByCancelSoldCount">
		update product AS a
		LEFT JOIN payment_detail AS b
		ON a.id = b.product_id
		SET a.sold_count = a.sold_count - 1  WHERE b.merchant_uid = #{merchantUid}
	</update>
		
		
		
		
		
		
		  
	
</mapper>